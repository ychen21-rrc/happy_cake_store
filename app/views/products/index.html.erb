<div class="container my-4">

  <!-- Title -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Happy Cake Store</h1>
    <%= link_to "View Cart", cart_path, class: "btn btn-outline-primary" %>
  </div>

  <!-- Category Nav (2.2) -->
  <div class="mb-3">
    <strong class="me-2">Categories:</strong>
    <%= link_to "All", products_path(request.query_parameters.except(:category_id, :page)),
                class: "btn btn-sm btn-outline-secondary me-1 #{'active' if params[:category_id].blank?}" %>
    <% @categories.each do |cat| %>
      <%= link_to cat.name,
                  products_path(request.query_parameters.merge(category_id: cat.id, page: nil)),
                  class: "btn btn-sm btn-outline-secondary me-1 #{'active' if params[:category_id].to_i == cat.id}" %>
    <% end %>
  </div>

  <!-- Filter Buttons (2.4) -->
  <div class="mb-3">
    <strong class="me-2">Filter:</strong>
    <%= link_to "Newest",
                products_path(request.query_parameters.merge(filter: "new", page: nil)),
                class: "btn btn-sm btn-outline-success me-1 #{'active' if params[:filter] == 'new'}" %>

    <%= link_to "On Sale",
                products_path(request.query_parameters.merge(filter: "sale", page: nil)),
                class: "btn btn-sm btn-outline-danger me-1 #{'active' if params[:filter] == 'sale'}" %>

    <%= link_to "Clear Filter",
                products_path(request.query_parameters.except(:filter, :page)),
                class: "btn btn-sm btn-outline-dark" %>
  </div>

  <!-- Search Form (2.6) -->
  <%= form_with url: products_path, method: :get, local: true, class: "row g-2 mb-4" do |f| %>
    <div class="col-md-5">
      <%= f.text_field :q, value: params[:q], placeholder: "Search cake name or description...",
                       class: "form-control" %>
    </div>

    <div class="col-md-4">
      <%= f.select :category_id,
                   options_for_select([["All Categories", ""]] + @categories.map { |c| [c.name, c.id] },
                                      params[:category_id]),
                   {}, class: "form-select" %>
    </div>

    <!-- keep existing filter when searching -->
    <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>

    <div class="col-md-3">
      <%= f.submit "Search", class: "btn btn-primary w-100" %>
    </div>
  <% end %>

  <!-- Products Grid -->
  <div class="row g-3">
    <% @products.each do |product| %>
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm">

          <!-- Image -->
          <% if product.images.attached? %>
            <%= image_tag product.images.first.variant(resize_to_limit: [500, 350]),
                          class: "card-img-top", alt: product.name %>
          <% else %>
            <div class="bg-light d-flex align-items-center justify-content-center"
                 style="height: 220px;">
              <span class="text-muted">No image</span>
            </div>
          <% end %>

          <div class="card-body d-flex flex-column">
            <h5 class="card-title"><%= product.name %></h5>

            <!-- badges -->
            <div class="mb-2">
              <% if product.is_new %>
                <span class="badge text-bg-success me-1">New</span>
              <% end %>
              <% if product.is_on_sale %>
                <span class="badge text-bg-danger">Sale</span>
              <% end %>
            </div>

            <p class="card-text text-muted small">
              <%= truncate(product.description, length: 90) %>
            </p>

            <div class="mt-auto d-flex justify-content-between align-items-center">
              <strong>$<%= number_with_precision(product.price, precision: 2) %></strong>

              <div class="d-flex gap-2">
                <%= link_to "Details", product_path(product), class: "btn btn-sm btn-outline-secondary" %>

                <%= button_to "Add to Cart",
                              add_cart_path(product_id: product.id),
                              method: :post,
                              class: "btn btn-sm btn-primary" %>
              </div>
            </div>
          </div>

        </div>
      </div>
    <% end %>
  </div>

  <!-- Pagination (2.5) -->
  <div class="mt-4 d-flex justify-content-center">
    <%= paginate @products %>
  </div>

</div>
