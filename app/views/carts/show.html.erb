<h3 class="mb-3">Your Cart</h3>

<% if @items.any? %>
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Product</th>
          <th style="width: 140px;">Quantity</th>
          <th>Price</th>
          <th>Subtotal</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% total = 0 %>
        <% @items.each do |p| %>
          <% qty = session[:cart][p.id.to_s] %>
          <% line = p.price * qty %>
          <% total += line %>
          <tr>
            <td>
              <div class="d-flex align-items-center gap-3">
                <% if p.images.attached? %>
                  <%= image_tag p.images.first.variant(resize_to_limit: [80,80]), class: "rounded" %>
                <% end %>
                <div>
                  <div class="fw-semibold"><%= p.name %></div>
                  <div class="small text-muted"><%= truncate(p.description, length: 60) %></div>
                </div>
              </div>
            </td>

            <td>
              <%= form_with url: update_cart_path(p.id), method: :patch, local: true do |f| %>
                <div class="input-group input-group-sm">
                  <%= f.number_field :quantity, value: qty, min: 1, class: "form-control" %>
                  <%= f.submit "Update", class: "btn btn-outline-secondary" %>
                </div>
              <% end %>
            </td>

            <td>$<%= sprintf("%.2f", p.price) %></td>
            <td>$<%= sprintf("%.2f", line) %></td>

            <td>
              <%= button_to "Remove", remove_cart_path(p.id), method: :delete,
                    class: "btn btn-outline-danger btn-sm",
                    data: { confirm: "Remove this item?" } %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end">
    <div class="card shadow-sm" style="min-width: 280px;">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <span>Subtotal</span>
          <strong>$<%= sprintf("%.2f", total) %></strong>
        </div>
        <%= link_to "Checkout", checkout_path, class: "btn btn-primary w-100 mt-3" %>
      </div>
    </div>
  </div>
<% else %>
  <div class="alert alert-info">
    Your cart is empty. <%= link_to "Start shopping", products_path %>.
  </div>
<% end %>
